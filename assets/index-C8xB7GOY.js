const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RegisterView-DECwSdxk.js","assets/vue-vendor-C77FZFBx.js","assets/supabase-D4wOtLzw.js","assets/LoginView-nF8U6lHc.js","assets/_plugin-vue_export-helper-DlAUqK2U.js","assets/LoginView-tn0RQdqM.css","assets/DashboardView-5__9bcfB.js","assets/AdminPanel-Bd5L5XXr.js","assets/qrcode-DpynCwP9.js","assets/ProfileView-DPRAjL0d.js","assets/DevicesView-BLJDIef8.js","assets/OfflineView-EWznaMuB.js"])))=>i.map(i=>d[i]);
import{c as N,r as k,o as q,a as K,b,u as U,d as j,e as C,f as Y}from"./vue-vendor-C77FZFBx.js";import{_ as g}from"./supabase-D4wOtLzw.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const E of i.addedNodes)E.tagName==="LINK"&&E.rel==="modulepreload"&&s(E)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();const J={__name:"App",setup(n){return(e,t)=>{const s=k("router-view");return q(),N(s)}}};function h(n){const e=new Uint8Array(n);let t="";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function A(n){const e=n.replace(/-/g,"+").replace(/_/g,"/"),t="=".repeat((4-e.length%4)%4),s=atob(e+t),a=new Uint8Array(s.length);for(let i=0;i<s.length;i++)a[i]=s.charCodeAt(i);return a.buffer}class F{TOKEN_KEY="auth_token";USER_KEY="auth_user";async saveToken(e){try{"SecureStorage"in window?await window.SecureStorage.set(this.TOKEN_KEY,e):localStorage.setItem(this.TOKEN_KEY,e)}catch(t){console.error("Failed to save token:",t)}}async getToken(){try{return"SecureStorage"in window?await window.SecureStorage.get(this.TOKEN_KEY):localStorage.getItem(this.TOKEN_KEY)}catch(e){return console.error("Failed to get token:",e),null}}async saveUser(e){try{"SecureStorage"in window?await window.SecureStorage.set(this.USER_KEY,JSON.stringify(e)):localStorage.setItem(this.USER_KEY,JSON.stringify(e))}catch(t){console.error("Failed to save user:",t)}}async getUser(){try{let e;return"SecureStorage"in window?e=await window.SecureStorage.get(this.USER_KEY):e=localStorage.getItem(this.USER_KEY),e?JSON.parse(e):null}catch(e){return console.error("Failed to get user:",e),null}}async clear(){try{"SecureStorage"in window?(await window.SecureStorage.remove(this.TOKEN_KEY),await window.SecureStorage.remove(this.USER_KEY)):(localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY))}catch(e){console.error("Failed to clear storage:",e)}}}const w=new F,_="https://prlivcmqjqjypclkcovl.supabase.co/functions/v1/auth",m=K(null),f=K(null),v=K(!1),y=K(null);function $(){const n=U(),e=b(()=>!!f.value&&!!m.value);async function t(){v.value=!0;try{const c=await w.getToken(),r=await w.getUser();c&&r&&(f.value=c,m.value=r)}catch(c){console.error("Initialization error:",c)}finally{v.value=!1}}async function s(c,r){v.value=!0,y.value=null;try{const o=await fetch(`${_}/register/prepare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inviteToken:c,displayName:r})});if(!o.ok){const u=await o.json();throw new Error(u.error||"Failed to prepare registration")}return await o.json()}catch(o){throw y.value=o.message,o}finally{v.value=!1}}async function a(c,r){try{if(!window.PublicKeyCredential)throw new Error("WebAuthn is not supported on this device");const o=await s(c,r),l={...o.publicKey,challenge:A(o.publicKey.challenge),user:{...o.publicKey.user,id:A(o.publicKey.user.id)}},u=await navigator.credentials.create({publicKey:l});if(!u)throw new Error("Failed to create credential");const O=u.response,S={id:u.id,rawId:h(u.rawId),response:{clientDataJSON:h(O.clientDataJSON),attestationObject:h(O.attestationObject)},type:u.type},d=await fetch(`${_}/register/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challengeId:o.challengeId,attestation:S,displayName:r})});if(!d.ok){const P=await d.json();throw new Error(P.error||"Registration failed")}const p=await d.json();return f.value=p.token,m.value=p.user,await w.saveToken(p.token),await w.saveUser(p.user),p}catch(o){throw y.value=o.message,o}}async function i(c){v.value=!0,y.value=null;try{console.log("Login prepare: calling",`${_}/login/prepare`);const r=await fetch(`${_}/login/prepare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:c})});if(console.log("Login prepare response:",r.status,r.statusText),!r.ok){const l=await r.json().catch(()=>({error:"Unknown error"}));throw console.error("Login prepare error:",l),new Error(l.error||`Failed to prepare login (${r.status})`)}const o=await r.json();return console.log("Login prepare success:",o),o}catch(r){throw console.error("Login prepare exception:",r),y.value=r.message,r}finally{v.value=!1}}async function E(c){try{if(!window.PublicKeyCredential)throw new Error("WebAuthn is not supported on this device");const r=await i(c),o={...r.publicKey,challenge:A(r.publicKey.challenge)};o.allowCredentials&&(o.allowCredentials=o.allowCredentials.map(p=>({...p,id:A(p.id)})));const l=await navigator.credentials.get({publicKey:o});if(!l)throw new Error("Failed to get credential");const u=l.response,O={id:l.id,rawId:h(l.rawId),response:{clientDataJSON:h(u.clientDataJSON),authenticatorData:h(u.authenticatorData),signature:h(u.signature),userHandle:u.userHandle?h(u.userHandle):void 0},type:l.type},S=await fetch(`${_}/login/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challengeId:r.challengeId,assertion:O})});if(!S.ok){const p=await S.json();throw new Error(p.error||"Login failed")}const d=await S.json();return f.value=d.token,m.value=d.user,await w.saveToken(d.token),await w.saveUser(d.user),d}catch(r){throw y.value=r.message,r}}async function R(){f.value=null,m.value=null,await w.clear(),n.push("/login")}function D(){return m.value?.role==="admin"}async function I(c,r={}){const o=new Headers(r.headers);f.value&&o.set("Authorization",`Bearer ${f.value}`);const l=await fetch(`${_}${c}`,{...r,headers:o});if(l.status===401)throw await R(),new Error("Authentication expired");return l}return{user:b(()=>m.value),token:b(()=>f.value),isAuthenticated:e,isLoading:b(()=>v.value),error:b(()=>y.value),initialize:t,register:a,login:E,logout:R,isAdmin:D,apiRequest:I}}const B=[{path:"/",redirect:"/dashboard"},{path:"/register",name:"Register",component:()=>g(()=>import("./RegisterView-DECwSdxk.js"),__vite__mapDeps([0,1,2])),meta:{requiresAuth:!1}},{path:"/login",name:"Login",component:()=>g(()=>import("./LoginView-nF8U6lHc.js"),__vite__mapDeps([3,1,4,2,5])),meta:{requiresAuth:!1}},{path:"/dashboard",name:"Dashboard",component:()=>g(()=>import("./DashboardView-5__9bcfB.js"),__vite__mapDeps([6,1,4,2,5])),meta:{requiresAuth:!0}},{path:"/admin",name:"Admin",component:()=>g(()=>import("./AdminPanel-Bd5L5XXr.js"),__vite__mapDeps([7,1,2,8,4,5])),meta:{requiresAuth:!0,requiresAdmin:!0}},{path:"/profile",name:"Profile",component:()=>g(()=>import("./ProfileView-DPRAjL0d.js"),__vite__mapDeps([9,4])),meta:{requiresAuth:!0}},{path:"/devices",name:"Devices",component:()=>g(()=>import("./DevicesView-BLJDIef8.js"),__vite__mapDeps([10,4])),meta:{requiresAuth:!0}},{path:"/offline",name:"Offline",component:()=>g(()=>import("./OfflineView-EWznaMuB.js"),__vite__mapDeps([11,4])),meta:{requiresAuth:!1}}],L=j({history:C("/"),routes:B,scrollBehavior(n,e,t){return t||{top:0}}});L.beforeEach(async(n,e,t)=>{const{isAuthenticated:s,user:a,initialize:i}=$();if(!s.value&&!a.value&&await i(),n.meta.requiresAuth&&!s.value){n.query.invite?t({name:"Register",query:{invite:n.query.invite}}):t({name:"Login",query:{redirect:n.fullPath}});return}if(n.meta.requiresAdmin&&a.value?.role!=="admin"){t({name:"Dashboard"});return}if(s.value&&(n.name==="Login"||n.name==="Register")){t({name:"Dashboard"});return}t()});const T=Y(J);T.use(L);T.config.errorHandler=(n,e,t)=>{console.error("Global error:",n),console.error("Component:",e),console.error("Error info:",t)};T.config.warnHandler=(n,e,t)=>{console.warn("Global warning:",n),console.warn("Component:",e),console.warn("Trace:",t)};T.mount("#app");"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("controllerchange",()=>{console.log("New service worker activated")});export{$ as u};
