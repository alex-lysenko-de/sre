const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RegisterView-CeGZ_Wn0.js","assets/vue-vendor-DH3SoYu2.js","assets/_plugin-vue_export-helper-BCo6x5W8.js","assets/supabase-DJmvsvGB.js","assets/RegisterView-tn0RQdqM.css","assets/LoginView-CI1HF0r1.js","assets/DashboardView-CNTRtsdV.js","assets/AdminPanel-C4m0PqW0.js","assets/qrcode-BqwfzOFP.js","assets/ProfileView-DgJMbhc5.js","assets/DevicesView-DgJMbhc5.js","assets/OfflineView-DgJMbhc5.js","assets/NotFoundView-DgJMbhc5.js"])))=>i.map(i=>d[i]);
import{c as e,r as t,o as a,a as r,b as n,u as i,d as o,e as s,f as l}from"./vue-vendor-DH3SoYu2.js";import{_ as c}from"./supabase-DJmvsvGB.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const u={__name:"App",setup:r=>(r,n)=>{const i=t("router-view");return a(),e(i)}};function d(e){const t=new Uint8Array(e);let a="";for(let r=0;r<t.length;r++)a+=String.fromCharCode(t[r]);return btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function h(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),a="=".repeat((4-t.length%4)%4),r=atob(t+a),n=new Uint8Array(r.length);for(let i=0;i<r.length;i++)n[i]=r.charCodeAt(i);return n.buffer}const p=new class{TOKEN_KEY="auth_token";USER_KEY="auth_user";async saveToken(e){try{"SecureStorage"in window?await window.SecureStorage.set(this.TOKEN_KEY,e):localStorage.setItem(this.TOKEN_KEY,e)}catch(t){}}async getToken(){try{return"SecureStorage"in window?await window.SecureStorage.get(this.TOKEN_KEY):localStorage.getItem(this.TOKEN_KEY)}catch(e){return null}}async saveUser(e){try{"SecureStorage"in window?await window.SecureStorage.set(this.USER_KEY,JSON.stringify(e)):localStorage.setItem(this.USER_KEY,JSON.stringify(e))}catch(t){}}async getUser(){try{let e;return e="SecureStorage"in window?await window.SecureStorage.get(this.USER_KEY):localStorage.getItem(this.USER_KEY),e?JSON.parse(e):null}catch(e){return null}}async clear(){try{"SecureStorage"in window?(await window.SecureStorage.remove(this.TOKEN_KEY),await window.SecureStorage.remove(this.USER_KEY)):(localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY))}catch(e){}}},w="https://prlivcmqjqjypclkcovl.supabase.co/functions/v1/auth",g=r(null),m=r(null),f=r(!1),y=r(null);function v(){const e=i(),t=n(()=>!!m.value&&!!g.value);async function a(){m.value=null,g.value=null,await p.clear(),e.push("/login")}return{user:n(()=>g.value),token:n(()=>m.value),isAuthenticated:t,isLoading:n(()=>f.value),error:n(()=>y.value),initialize:async function(){f.value=!0;try{const e=await p.getToken(),t=await p.getUser();e&&t&&(m.value=e,g.value=t)}catch(e){}finally{f.value=!1}},register:async function(e,t){try{if(!window.PublicKeyCredential)throw new Error("WebAuthn is not supported on this device");const a=await async function(e,t){f.value=!0,y.value=null;try{const a=await fetch(`${w}/register/prepare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inviteToken:e,displayName:t})});if(!a.ok){const e=await a.json();throw new Error(e.error||"Failed to prepare registration")}return await a.json()}catch(a){throw y.value=a.message,a}finally{f.value=!1}}(e,t),r={...a.publicKey,challenge:h(a.publicKey.challenge),user:{...a.publicKey.user,id:h(a.publicKey.user.id)}},n=await navigator.credentials.create({publicKey:r});if(!n)throw new Error("Failed to create credential");const i=n.response,o={id:n.id,rawId:d(n.rawId),response:{clientDataJSON:d(i.clientDataJSON),attestationObject:d(i.attestationObject)},type:n.type},s=await fetch(`${w}/register/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challengeId:a.challengeId,attestation:o,displayName:t})});if(!s.ok){const e=await s.json();throw new Error(e.error||"Registration failed")}const l=await s.json();return m.value=l.token,g.value=l.user,await p.saveToken(l.token),await p.saveUser(l.user),l}catch(a){throw y.value=a.message,a}},login:async function(e){try{if(!window.PublicKeyCredential)throw new Error("WebAuthn is not supported on this device");const t=await async function(e){f.value=!0,y.value=null;try{const t=await fetch(`${w}/login/prepare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})});if(!t.ok){const e=await t.json().catch(()=>({error:"Unknown error"}));throw new Error(e.error||`Failed to prepare login (${t.status})`)}return await t.json()}catch(t){throw y.value=t.message,t}finally{f.value=!1}}(e),a={...t.publicKey,challenge:h(t.publicKey.challenge)};a.allowCredentials&&(a.allowCredentials=a.allowCredentials.map(e=>({...e,id:h(e.id)})));const r=await navigator.credentials.get({publicKey:a});if(!r)throw new Error("Failed to get credential");const n=r.response,i={id:r.id,rawId:d(r.rawId),response:{clientDataJSON:d(n.clientDataJSON),authenticatorData:d(n.authenticatorData),signature:d(n.signature),userHandle:n.userHandle?d(n.userHandle):void 0},type:r.type},o=await fetch(`${w}/login/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challengeId:t.challengeId,assertion:i})});if(!o.ok){const e=await o.json();throw new Error(e.error||"Login failed")}const s=await o.json();return m.value=s.token,g.value=s.user,await p.saveToken(s.token),await p.saveUser(s.user),s}catch(t){throw y.value=t.message,t}},logout:a,isAdmin:function(){return"admin"===g.value?.role},apiRequest:async function(e,t={}){const r=new Headers(t.headers);m.value&&r.set("Authorization",`Bearer ${m.value}`);const n=await fetch(`${w}${e}`,{...t,headers:r});if(401===n.status)throw await a(),new Error("Authentication expired");return n}}}const _=[{path:"/",redirect:"/dashboard"},{path:"/register",name:"Register",component:()=>c(()=>import("./RegisterView-CeGZ_Wn0.js"),__vite__mapDeps([0,1,2,3,4])),meta:{requiresAuth:!1}},{path:"/login",name:"Login",component:()=>c(()=>import("./LoginView-CI1HF0r1.js"),__vite__mapDeps([5,1,2,3,4])),meta:{requiresAuth:!1}},{path:"/dashboard",name:"Dashboard",component:()=>c(()=>import("./DashboardView-CNTRtsdV.js"),__vite__mapDeps([6,1,2,3,4])),meta:{requiresAuth:!0}},{path:"/admin",name:"Admin",component:()=>c(()=>import("./AdminPanel-C4m0PqW0.js"),__vite__mapDeps([7,1,3,8,2,4])),meta:{requiresAuth:!0,requiresAdmin:!0}},{path:"/profile",name:"Profile",component:()=>c(()=>import("./ProfileView-DgJMbhc5.js"),__vite__mapDeps([9,2])),meta:{requiresAuth:!0}},{path:"/devices",name:"Devices",component:()=>c(()=>import("./DevicesView-DgJMbhc5.js"),__vite__mapDeps([10,2])),meta:{requiresAuth:!0}},{path:"/offline",name:"Offline",component:()=>c(()=>import("./OfflineView-DgJMbhc5.js"),__vite__mapDeps([11,2])),meta:{requiresAuth:!1}},{path:"/:pathMatch(.*)*",name:"NotFound",component:()=>c(()=>import("./NotFoundView-DgJMbhc5.js"),__vite__mapDeps([12,2]))}],E=o({history:s("/sre/"),routes:_,scrollBehavior:(e,t,a)=>a||{top:0}});E.beforeEach(async(e,t,a)=>{const{isAuthenticated:r,user:n,initialize:i}=v();r.value||n.value||await i(),!e.meta.requiresAuth||r.value?e.meta.requiresAdmin&&"admin"!==n.value?.role?a({name:"Dashboard"}):!r.value||"Login"!==e.name&&"Register"!==e.name?a():a({name:"Dashboard"}):e.query.invite?a({name:"Register",query:{invite:e.query.invite}}):a({name:"Login",query:{redirect:e.fullPath}})});const S=l(u);S.use(E),S.config.errorHandler=(e,t,a)=>{},S.config.warnHandler=(e,t,a)=>{},S.mount("#app"),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("controllerchange",()=>{});export{v as u};
