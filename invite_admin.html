<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Invite Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #1a202c;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 8px;
      text-align: center;
    }

    .subtitle {
      color: #718096;
      text-align: center;
      margin-bottom: 32px;
      font-size: 14px;
    }

    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 24px;
      display: flex;
      align-items: start;
    }

    .warning-icon {
      color: #ffc107;
      font-size: 20px;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .warning-text {
      font-size: 13px;
      color: #856404;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #4a5568;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    select, input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .result {
      margin-top: 32px;
      padding: 24px;
      background: #f7fafc;
      border-radius: 8px;
      display: none;
    }

    .result.show {
      display: block;
    }

    .result h3 {
      color: #2d3748;
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
    }

    .qr-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .url-container {
      margin-bottom: 16px;
    }

    .url-label {
      font-size: 12px;
      color: #718096;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .url-box {
      display: flex;
      gap: 8px;
    }

    .url-input {
      flex: 1;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: white;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
    }

    .copy-btn {
      width: auto;
      padding: 10px 20px;
      font-size: 14px;
      background: #48bb78;
    }

    .copy-btn:hover {
      background: #38a169;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .info-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .info-label {
      font-size: 11px;
      color: #718096;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .info-value {
      font-size: 14px;
      color: #2d3748;
      font-weight: 600;
    }

    .error {
      background: #fed7d7;
      color: #c53030;
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
      display: none;
      font-size: 14px;
    }

    .error.show {
      display: block;
    }

    .loading {
      text-align: center;
      margin-top: 16px;
      color: #718096;
      font-size: 14px;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .success-badge {
      display: inline-block;
      background: #48bb78;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Admin Invite Generator</h1>
    <p class="subtitle">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</p>

    <div class="warning">
      <span class="warning-icon">‚ö†Ô∏è</span>
      <div class="warning-text">
        <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ git. 
        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ invite —Ç–æ–∫–µ–Ω–æ–≤.
      </div>
    </div>

    <form id="inviteForm">
      <div class="form-group">
        <label for="role">–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <select id="role" required>
          <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
          <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
        </select>
      </div>

      <div class="form-group">
        <label for="expiry">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
        <select id="expiry" required>
          <option value="1">1 —á–∞—Å</option>
          <option value="24">24 —á–∞—Å–∞ (1 –¥–µ–Ω—å)</option>
          <option value="72">72 —á–∞—Å–∞ (3 –¥–Ω—è)</option>
          <option value="168">168 —á–∞—Å–æ–≤ (7 –¥–Ω–µ–π)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="appUrl">URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <input 
          type="url" 
          id="appUrl" 
		  title="–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è localhost:3000"
		  value = "https://alex-lysenko-de.github.io/sre"
          placeholder="https://alex-lysenko-de.github.io/sre (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è localhost:3000)"
        >
      </div>

      <button type="submit" id="generateBtn">
        –°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥
      </button>
    </form>

    <div class="error" id="errorMsg"></div>
    
    <div class="loading" id="loading" style="display: none;">
      <span class="spinner"></span> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è invite —Ç–æ–∫–µ–Ω–∞...
    </div>

    <div class="result" id="result">
      <span class="success-badge">‚úì –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ</span>
      <h3>QR-–∫–æ–¥ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h3>
      
      <div class="qr-container">
        <div id="qrcode"></div>
      </div>

      <div class="url-container">
        <div class="url-label">–°–°–´–õ–ö–ê –î–õ–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò</div>
        <div class="url-box">
          <input type="text" id="inviteUrl" class="url-input" readonly>
          <button type="button" class="copy-btn" onclick="copyUrl()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">–†–æ–ª—å</div>
          <div class="info-value" id="roleInfo"></div>
        </div>
        <div class="info-item">
          <div class="info-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</div>
          <div class="info-value" id="expiryInfo"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env.prod
    const ENV = {
      VITE_API_BASE_URL: 'https://prlivcmqjqjypclkcovl.supabase.co/functions/v1/auth',
      VITE_SUPABASE_URL: 'https://prlivcmqjqjypclkcovl.supabase.co',
      VITE_SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBybGl2Y21xanFqeXBjbGtjb3ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNDcwMTIsImV4cCI6MjA2OTcyMzAxMn0.cQds_3P7_fBKQ3iiaw82PNP1HxIqS_fN4aAux3ywDWM'
    };

    let currentQRCode = null;

    document.getElementById('inviteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const role = document.getElementById('role').value;
      const expiresInHours = parseInt(document.getElementById('expiry').value);
      const customAppUrl = document.getElementById('appUrl').value;
      const appUrl = customAppUrl || 'http://localhost:3000';

      // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      document.getElementById('loading').style.display = 'block';
      document.getElementById('result').classList.remove('show');
      document.getElementById('errorMsg').classList.remove('show');
      document.getElementById('generateBtn').disabled = true;

      try {
        const response = await fetch(`${ENV.VITE_API_BASE_URL}/invite/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${ENV.VITE_SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            role: role,
            expiresInHours: expiresInHours
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —Ç–æ–∫–µ–Ω–æ–º
        const inviteUrl = `${appUrl}?invite=${data.inviteToken}`;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        displayResult(inviteUrl, role, data.expiresAt);

      } catch (error) {
        console.error('Error:', error);
        showError(error.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
      }
    });

    function displayResult(url, role, expiresAt) {
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π QR-–∫–æ–¥
      if (currentQRCode) {
        document.getElementById('qrcode').innerHTML = '';
      }

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π QR-–∫–æ–¥
      currentQRCode = new QRCode(document.getElementById('qrcode'), {
        text: url,
        width: 256,
        height: 256,
        colorDark: '#4F46E5',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      document.getElementById('inviteUrl').value = url;
      document.getElementById('roleInfo').textContent = role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      
      const expiryDate = new Date(expiresAt);
      document.getElementById('expiryInfo').textContent = expiryDate.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      document.getElementById('result').classList.add('show');
    }

    function copyUrl() {
      const urlInput = document.getElementById('inviteUrl');
      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

      navigator.clipboard.writeText(urlInput.value).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        btn.style.background = '#38a169';
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
      });
    }

    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = `‚ùå –û—à–∏–±–∫–∞: ${message}`;
      errorMsg.classList.add('show');
    }

    // –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('inviteForm').addEventListener('input', () => {
      document.getElementById('errorMsg').classList.remove('show');
    });
  </script>
</body>
</html>